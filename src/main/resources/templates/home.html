<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/app.css"/>
  <title>Inicio</title>

  <script src="https://www.google.com/recaptcha/api.js"
          async defer
          th:if="${recaptchaEnabled}"></script>
</head>
<body>

<nav class="navbar">
  <div class="nav-inner">
    <div class="brand">
      <div class="logo">A</div>
      <span>DemoApp</span>
    </div>

    <div class="nav-links">
      <a href="/" class="active">Inicio</a>
      <a href="/features">Explorar</a>
      <a href="/calculator">Calculadora</a>
      <a href="/contact">Formulario</a>
      <a href="/carousel">Carrusel</a>
      <a href="/hello">Hola</a>
    </div>
  </div>
</nav>

<!-- BREADCRUMBS -->
<div class="crumbs">
  <div class="trail">
    <a href="/">Inicio</a>
    <span class="sep">›</span>
    <span class="current">Registro</span>
  </div>
</div>

<main class="main">
  <div class="card">

    <h1>Registro</h1>
    <p class="sub">Guarda un dato en la base de datos</p>

    <!-- Errores globales (binding.reject(...)) -->
    <div class="err" th:if="${#fields.hasGlobalErrors()}"
         th:each="e : ${#fields.globalErrors()}"
         th:text="${e}"></div>

    <!-- Error de DB (del controller) -->
    <div class="err" th:if="${dbError}" th:text="${dbError}"></div>

    <form id="regForm"
          th:action="@{/register}"
          th:object="${registrationForm}"
          method="post"
          autocomplete="off"
          novalidate>

      <input type="hidden"
             th:if="${_csrf != null}"
             th:name="${_csrf.parameterName}"
             th:value="${_csrf.token}"/>

      <div class="row">
        <label for="username">Dato a insertar</label>
        <input id="username"
               class="input"
               th:field="*{username}"
               placeholder="Ej. nombre_de_usuario"
               maxlength="30"
               inputmode="text"
               autocomplete="off"
               pattern="^[A-Za-z0-9._-]{3,30}$"
               title="3-30 caracteres: letras, números, punto, guion bajo y guion medio."
               required />
        <div class="err" th:if="${#fields.hasErrors('username')}" th:errors="*{username}"></div>
      </div>

      <div class="row" th:if="${recaptchaEnabled}">
        <div class="g-recaptcha" th:attr="data-sitekey=${recaptchaSiteKey}"></div>
        <div class="err" th:if="${recaptchaError}" th:text="${recaptchaError}"></div>
      </div>

      <!-- Error del cliente -->
      <div id="clientError" class="err" style="display:none;"></div>

      <button class="btn" type="submit">Guardar</button>
    </form>

  </div>
</main>

<script>
  const form = document.getElementById('regForm');
  const username = document.getElementById('username');
  const clientError = document.getElementById('clientError');

  function showClientError(msg){
    if (!clientError) return;
    clientError.textContent = msg; // seguro (no HTML)
    clientError.style.display = 'block';
  }
  function clearClientError(){
    if (!clientError) return;
    clientError.textContent = '';
    clientError.style.display = 'none';
  }

  function hasBadChars(s){
    if (!s) return false;
    if (s.includes('<') || s.includes('>')) return true;
    return /[\u0000-\u001F\u007F]/.test(s); // control chars
  }

  function sanitizeUsername(s){
    // quita espacios y control chars
    return (s || '')
      .replace(/[\u0000-\u001F\u007F]/g, '')
      .trim()
      .replace(/\s+/g, '');
  }

  document.addEventListener('DOMContentLoaded', () => {
    if (username) {
      username.addEventListener('input', () => {
        clearClientError();
        username.value = sanitizeUsername(username.value);

        // bloqueo rápido de < >
        if (hasBadChars(username.value)) {
          username.value = username.value.replace(/[<>]/g, '');
          showClientError("No se permiten caracteres extraños.");
        }
      });

      username.addEventListener('paste', (e) => {
        const text = (e.clipboardData || window.clipboardData).getData('text');
        if (hasBadChars(text)) {
          e.preventDefault();
          showClientError("No se permiten etiquetas HTML ni caracteres extraños.");
        }
      });
    }

    if (form) {
      form.addEventListener('submit', (e) => {
        clearClientError();

        const val = sanitizeUsername(username ? username.value : '');
        if (username) username.value = val;

        if (hasBadChars(val)) {
          e.preventDefault();
          showClientError("No se permiten caracteres extraños.");
          return;
        }

        // Forzar validación HTML5 del pattern/required
        if (!form.checkValidity()) {
          e.preventDefault();
          showClientError("Usuario inválido. Usa 3-30 caracteres: letras, números, . _ -");
        }
      });
    }
  });
</script>

</body>
</html>
